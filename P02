<?xml version="1.0" encoding="utf-8"?>
<FDL version="1.5">
  <TypeDefinition url="..\default_typedef.xml"/>
  <Form id="NSPCPC010_P01" classname="COMPOPUP010_P06" left="0" top="0" width="1100" height="680" titletext="재고조사엑셀업로드" mnls="POP0032" onload="NSPCPC010_P01_onload">
    <Layouts>
      <Layout>
        <Static id="Static00" taborder="14" text="w&#13;&#10;25" cssclass="Guide_Color" visible="false" top="0" right="0" bottom="0" width="25"/>
        <Static id="Static57" taborder="15" text="h8" cssclass="Guide_Color2" visible="false" left="0" top="0" right="0" height="8"/>
        <Static id="Static02" taborder="16" text="w&#13;&#10;25" cssclass="Guide_Color" visible="false" left="0" top="0" bottom="0" width="25"/>
        <Grid id="grd_excel" cssclass="grd_POP_Basic" taborder="4" binddataset="ds_excel" autoenter="select" useinputpanel="false" cellsizingtype="col" autofittype="col" hideendline="both" oncelldblclick="grd_list_oncelldblclick" left="25" top="52" right="25" height="598" autosizingtype="none" autosizebandtype="body">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="65"/>
                <Column size="135"/>
                <Column size="230"/>
                <Column size="70"/>
                <Column size="70"/>
                <Column size="107"/>
                <Column size="370"/>
              </Columns>
              <Rows>
                <Row size="32" band="head"/>
                <Row size="30"/>
              </Rows>
              <Band id="head">
                <Cell text="NO"/>
                <Cell col="1" displaytype="text" edittype="text" text="PLU" expandchar="POP0011"/>
                <Cell col="2" text="상품명" expandchar="POP0008"/>
                <Cell col="3" text="공급가"/>
                <Cell col="4" text="수량"/>
                <Cell col="5" text="사유구분"/>
                <Cell col="6" text="오류내용" expandchar="POP0008"/>
              </Band>
              <Band id="body">
                <Cell style="align:right;" expr="expr:currow+1"/>
                <Cell col="1" displaytype="normal" edittype="none" style="align:center;" cssclass="Cell_WF_AlignL" text="bind:PLU_CD" editautoselect="false" tooltiptext="bind:CHK_PLU_CD"/>
                <Cell col="2" displaytype="normal" edittype="none" editfilter="none" style="align:left;" text="bind:GDS_NM" editautoselect="false"/>
                <Cell col="3" displaytype="number" style="align:right;" text="bind:GDS_COST"/>
                <Cell col="4" displaytype="number" style="align:right;" text="bind:REQ_QTY" tooltiptext="bind:CHK_REQ_QTY"/>
                <Cell col="5" displaytype="combo" text="bind:STR_RTN_RSN_TP" combodataset="ds_ComCd305" combocodecol="CD" combodatacol="CDNM" tooltiptext="bind:CHK_STR_RTN_RSN_TP"/>
                <Cell col="6" displaytype="normal" edittype="none" editfilter="none" style="align:left;" text="bind:ERR_MSG" wordwrap="english" editautoselect="false"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Static id="Static06" taborder="19" text="h30" cssclass="Guide_Color2" visible="false" left="0" right="0" bottom="0" height="30"/>
        <Button id="btn_submit" taborder="1" text="저장" cssclass="btn_WF_Grid" top="16" right="211" width="51" height="29" style="cursor:hand;" actType="R" mnls="POP0031" onclick="btn_submit_onclick"/>
        <Static id="Static08" taborder="21" text="엑셀업로드" cssclass="sta_WF_Title" left="25" top="11" width="163" height="37" style="padding:0 0 10 0;align:left middle;font:bold 11 Malgun gothic;" visible="false"/>
        <Button id="btn_upload" taborder="0" text="파일선택" cssclass="btn_WF_Grid01" top="16" right="264" width="83" height="29" style="cursor:hand;" actType="R" mnls="POP0031" onclick="btn_upload_onclick"/>
        <Button id="btn_down" taborder="2" text="엑셀양식다운로드" cssclass="btn_WF_Grid01" top="16" right="78" width="131" height="29" style="cursor:hand;" actType="R" mnls="POP0031" onclick="btn_down_onclick"/>
        <Button id="btn_cancel" taborder="3" text="닫기" cssclass="btn_WF_Grid01" top="16" right="25" width="51" height="29" style="cursor:hand;" actType="R" mnls="POP0031" onclick="btn_cancel_onclick"/>
        <Grid id="grd_excelDown" cssclass="grd_POP_Basic" taborder="30" binddataset="ds_excelDown" autoenter="select" useinputpanel="false" cellsizingtype="col" autofittype="col" hideendline="both" oncelldblclick="grd_list_oncelldblclick" left="25" top="708" right="25" height="596" visible="false">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="251"/>
                <Column size="130"/>
                <Column size="277"/>
              </Columns>
              <Rows>
                <Row size="32" band="head"/>
                <Row size="30"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="text" edittype="text" text="PLU" expandchar="POP0011"/>
                <Cell col="1" text="수량"/>
                <Cell col="2" text="사유구분"/>
              </Band>
              <Band id="body">
                <Cell displaytype="normal" edittype="none" cssclass="Cell_WF_AlignL" text="bind:PLU_CD" editautoselect="true"/>
                <Cell col="1" text="bind:REQ_QTY"/>
                <Cell col="2" text="bind:STR_RTN_RSN_TP"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Grid id="grd_excelCode" cssclass="grd_POP_Basic" taborder="31" binddataset="ds_ComCd305" autoenter="select" useinputpanel="false" cellsizingtype="col" autofittype="col" hideendline="both" oncelldblclick="grd_list_oncelldblclick" left="948" top="708" right="-898" height="596" visible="false">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="251"/>
                <Column size="413"/>
              </Columns>
              <Rows>
                <Row size="32" band="head"/>
                <Row size="30"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="text" edittype="text" text="코드" expandchar="POP0011"/>
                <Cell col="1" text="코드명"/>
              </Band>
              <Band id="body">
                <Cell displaytype="normal" edittype="none" cssclass="Cell_WF_AlignL" text="bind:CD" editautoselect="true"/>
                <Cell col="1" text="bind:CDNM"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Static id="st_chkMessage" taborder="32" cssclass="sta_WF_DescriptionB02" left="25" top="28" width="445" height="17" style="align:left middle;"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_excel" useclientlayout="true">
        <ColumnInfo>
          <Column id="NO" type="STRING" size="256"/>
          <Column id="PLU_CD" type="STRING" size="256"/>
          <Column id="GDS_NM" type="STRING" size="256"/>
          <Column id="GDS_COST" type="BIGDECIMAL" size="256"/>
          <Column id="NSTCK_QTY" type="BIGDECIMAL" size="256"/>
          <Column id="RTN_ENBL_QTY" type="BIGDECIMAL" size="256"/>
          <Column id="DVY_CD" type="STRING" size="256"/>
          <Column id="PTN_CD" type="STRING" size="256"/>
          <Column id="VEN_CD" type="STRING" size="256"/>
          <Column id="TAX_TP" type="STRING" size="256"/>
          <Column id="TAX_RT" type="STRING" size="256"/>
          <Column id="HDQ_SAL_PRC" type="STRING" size="256"/>
          <Column id="SUP_PRC" type="STRING" size="256"/>
          <Column id="REQ_QTY" type="BIGDECIMAL" size="256"/>
          <Column id="CONF_QTY" type="BIGDECIMAL" size="256"/>
          <Column id="AMT" type="BIGDECIMAL" size="256"/>
          <Column id="VAT" type="BIGDECIMAL" size="256"/>
          <Column id="STR_RTN_RSN_TP" type="STRING" size="256"/>
          <Column id="CHK_PLU_CD" type="STRING" size="256"/>
          <Column id="CHK_REQ_QTY" type="STRING" size="256"/>
          <Column id="CHK_STR_RTN_RSN_TP" type="STRING" size="256"/>
          <Column id="ERR_MSG" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_excelUpload" useclientlayout="true">
        <ColumnInfo>
          <Column id="PLU_CD" type="STRING" size="256"/>
          <Column id="REQ_QTY" type="BIGDECIMAL" size="256"/>
          <Column id="STR_RTN_RSN_TP" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_excelDown" useclientlayout="true">
        <ColumnInfo>
          <Column id="PLU_CD" type="STRING" size="256"/>
          <Column id="REQ_QTY" type="STRING" size="256"/>
          <Column id="STR_RTN_RSN_TP" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_cond" oncolumnchanged="ds_cond_oncolumnchanged" useclientlayout="true">
        <ColumnInfo>
          <Column id="CO_CD" type="STRING" size="256"/>
          <Column id="ORG_CD" type="STRING" size="256"/>
          <Column id="RTN_REQ_DT" type="STRING" size="256"/>
          <Column id="PGM_TP" type="STRING" size="256"/>
          <Column id="RTN_TP" type="STRING" size="256"/>
          <Column id="WM_SHIFT_TP" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="ds_ComCd305">
        <ColumnInfo>
          <Column id="CD" type="STRING" size="2"/>
          <Column id="NM" type="STRING" size="3"/>
          <Column id="CDNM" type="STRING" size="256"/>
          <Column id="VAL1" type="STRING" size="256"/>
          <Column id="VAL2" type="STRING" size="256"/>
          <Column id="VAL3" type="STRING" size="256"/>
          <Column id="VAL4" type="STRING" size="256"/>
          <Column id="VAL5" type="STRING" size="256"/>
          <Column id="NUM1" type="INT" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_InvChk" useclientlayout="true">
        <ColumnInfo>
          <Column id="INVCHK" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Bind/>
    <Script type="xscript5.0"><![CDATA[/**********************************************************************************************
 * 01. 업무구분       	: 점포운영 > 재고관리
 * 02. 화면            	: NSSMSI010_P02.xfdl
 * 03. 화면설명        	: 재고조사엑셀업로드
 * 04. 관련화면/서비스 	: 
 * 05. 수정이력        	: 
 **********************************************************************************************
 *  수정일     이  름   	사유 
 **********************************************************************************************
 *  2019-02-27         		최초작성
 ***********************************************************************************************/


/*==============================================================================================
* 1. Include Library JS File
*===============================================================================================*/

/*==============================================================================================
* 2. 로컬 변수  선언
*===============================================================================================*/ 
this.ORG_CD 	 = "";
this.RTN_REQ_DT  = ""; 
this.WM_SHIFT_TP = "";  // 물류이동유형(행사반품)
this.PGM_TP   	 = "";  // 프로그램구분
this.RTN_TP   	 = "";  // 반품유형(S013) 

this.ERR_ROW_CNT = 0;
this.TOT_ROW_CNT = 0;
/*==============================================================================================
* 3. Form onload 
*===============================================================================================*/ 
this.NSPCPC010_P01_onload = function(obj:Form, e:nexacro.LoadEventInfo)
{
	this.gfn_formOnload(obj);
	
	this.fn_load(obj);
	this.fn_setDefaultValue();		    // 4.4. 기본값 설정	
	// 3.2. call onload function
	this.fn_setButton();				// 4.1. 버턴 초기화 or Dispaly
 	this.fn_setDataset();			    // 4.2. DataSet 에 초기데이터 Load
 	this.fn_setCommonCode(obj);			// 4.3. 공통코드]
}


// 4.1. 폼 Load
this.fn_load = function(obj) { 

	this.ORG_CD 	= NXCore.getParameter(this, "paramOrgCd") ;
	this.RTN_REQ_DT	= NXCore.getParameter(this, "paramRtnReqDt") ;
	
	this.WM_SHIFT_TP	= NXCore.getParameter(this, "paramWmShiftTp") ;
	this.PGM_TP			= NXCore.getParameter(this, "paramPgmTp") ;
	this.RTN_TP			= NXCore.getParameter(this, "paramRtnTp") ;
	
}
	
/*==============================================================================================
* 4. Load 후 초기설정 및 Data Setting
*===============================================================================================*/
this.fn_setButton = function() {}
this.fn_setDataset = function() {}

// 4.3. 공통코드
this.fn_setCommonCode = function(obj) 
{
	// 공통코드 조회
	// @see NXCombo
	var combo = new NXCombo(obj);
	
	//반품구분
	combo.addCombo({'type':'C', 'comcd':'D305', 'dataset':this.ds_ComCd305 });
	
	combo.execute("COMBO", "fn_callback");	// 공통코드가 조회되고 나서 반드시 수행되어야 할 로직이 있을 경우 공통코드를 가져온 후 호출되는 callback함수에서 해당 내용 기술
	
}

// 4.4. 기본값 설정
this.fn_setDefaultValue = function() 
{
	//1) 그리드 설정
	this.gfn_addGridCols(this.grd_excel,{bRowNum:false,bCheckBox:false});
	
	//2) 엑셀 파일업로드 init
	this._excelFile = new NXUpload(this, this.ds_excelUpload, "E");		// E: excel, F:file(첨부파일)
		
	//3) 엑셀양식다운로드
	this._excelDown = new NXDownload(this, this.ds_excelDown, "E");		// E: excel, F:file(첨부파일)
	
	
	this.ds_cond.clearData();
 	var rowIdx = this.ds_cond.addRow();
 	this.ds_cond.setColumn(rowIdx , "CO_CD"      ,application.gv_compCd);
 	this.ds_cond.setColumn(rowIdx , "ORG_CD"     , this.ORG_CD);
 	this.ds_cond.setColumn(rowIdx , "RTN_REQ_DT" , this.RTN_REQ_DT);  
	this.ds_cond.setColumn(rowIdx , "PGM_TP"	 , this.PGM_TP) ; 		// 프로그램구분
	this.ds_cond.setColumn(rowIdx , "RTN_TP"	 , this.RTN_TP) ; 		// 반품유형
	this.ds_cond.setColumn(rowIdx , "WM_SHIFT_TP", this.WM_SHIFT_TP); 	//물류이동유형

}

/*==============================================================================================
* 5. Button Event Area. (공통 버턴 이벤트 함수 영역: 초기화, 조회, 저장, 등...)
*===============================================================================================*/


/*==============================================================================================
* 6. User CallBack Function.(사용자 콜백 함수)
*===============================================================================================*/
this.fn_callback = function(svcid, errcd, errmsg) {

	if (errcd < 0) return;
	
	switch ( svcid ) {	
		case "COMBO":
// 			if(!NXCore.isEmpty(this.gdsNm))
// 			{
// 				this.fn_search();
// 			}
			break;
		case "saveExcelUpload" :
			 NXCore.alert("Inf.I012"); //저장되었습니다.
			 this.gfn_popClose(this, NXCore.setPopupReturn({pv_save_yn:"Y"}));
			break;
			
		case "chkExcelUpload" :
			
			//this.ERR_ROW_CNT = this.ds_excel.getCaseCount("!NXCore.isEmpty(CHK_PLU_CD) || !NXCore.isEmpty(CHK_REQ_QTY) || !NXCore.isEmpty(CHK_STR_RTN_RSN_TP)");;
			this.ERR_ROW_CNT = this.ds_excel.getCaseCount("!NXCore.isEmpty(ERR_MSG)");
			this.TOT_ROW_CNT = this.ds_excel.rowcount;

			this.st_chkMessage.set_text("총건수:"+this.TOT_ROW_CNT+" / 에러건수:"+this.ERR_ROW_CNT);
			 
			break;
			
			
	}
}

/*
* 엑셀 업로드 callback
*/
this.fn_importCallback = function(obj,e) 
{
	if(this.ds_excelUpload.getRowCount() == 0)
	{
		NXCore.alert("업로드된 엑셀자료가 없습니다");
		return;
	}
	else if(this.ds_excelUpload.getRowCount() > 1000)
	{
		NXCore.alert("1000건 이상 업로드 할수 없습니다."); 
		this.ds_excelUpload.clearData();
		return;
	}  
	else  
	{ 
		//this.ds_excel.copyData(this.ds_excelUpload);
		var tx = new NXTransaction(this);
			tx.addInDataset	("ds_cond"				,"ds_cond:A");
			tx.addInDataset ("ds_excelUpload"		,"ds_excelUpload:A");
			tx.addOutDataset("ds_excel"				,"ds_excel");
			tx.setCallback	("fn_callback");
			tx.setService	("ns/tb/tb010/chkExcelUpload.do"); 
			tx.execute		("chkExcelUpload");
	}
}

/*==============================================================================================
* 7. Local Function. (사용자 정의 함수)
*    - 사용자 정의 함수는 fn_xxxx() 형태로 작성  + 기본 이벤트 function
*==============================================================================================*/

/*==============================================================================================
* 8. 컴포넌트 이벤트 
*==============================================================================================*/
//8.1. 저장버튼 클릭
this.btn_submit_onclick = function(obj:Button,  e:nexacro.ClickEventInfo) 
{ 
	
	if(this.ds_excel.getRowCount() == 0)
	{
		NXCore.alert("Inf.I015"); //데이터가 존재하지 않습니다. 먼저, 데이터를 담고 있는 엑셀 파일을 업로드해 주십시오.
		return;
	}  
	
	
	if(this.ERR_ROW_CNT > 0)
	{
		NXCore.alert("업로드한 내역에 오류가 있습니다. 수정후 다시 업로드하세요."); 
		var nRow = this.ds_excel.findRowExpr("!NXCore.isEmpty(ERR_MSG)"); 
		this.ds_excel.set_rowposition(nRow);
		return;
	} 
	 
 
	//현재 재고조사 여부 확인
	if(this.fn_chkInv(this.ds_cond.getColumn(0,"ORG_CD")))
	{
		return;
	} 
		
	if( !NXCore.confirm("Com.C201") ) return;  // 저장하시겠습니까? 

	var tx = new NXTransaction(this); 
	tx.setActionCd("S","A");
	tx.addInDataset("ds_cond" , "ds_cond:A");
	tx.addInDataset("ds_excel", "ds_excel:A"); 
	tx.setCallback("fn_callback");
	tx.setService("/ns/tb/tb010/saveRtnExcelUpload.do");
	tx.execute("saveExcelUpload");
}

//8.2. 닫기버튼 클릭
this.btn_cancel_onclick = function(obj:Button,  e:nexacro.ClickEventInfo) 
{
    this.gfn_popClose(this, NXCore.setPopupReturn({pv_save_yn:"N"}));
}

//8.3. 엑셀 업로드 
this.btn_upload_onclick = function(obj:Button,  e:nexacro.ClickEventInfo)
{
	// 엑셀 객체 생성
	this.ds_excelUpload.clearData();
	
	this.ERR_ROW_CNT =0;
	this.TOT_ROW_CNT =0;
	
	var excel = new NXExcel(this);
		excel.addImport(this.ds_excelUpload, {sheetindex:0, start:'A5'} );	// end 생략가능  		
		excel.importExcel({callback:"fn_importCallback"});
}

//8.4. 양식다운로드
this.btn_down_onclick = function(obj:Button,  e:nexacro.ClickEventInfo) 
{	 
	var arrObj = new Array();
	var objGrid = {};
		objGrid.grid = this.grd_excelDown;
		objGrid.title = "BSDC반품";
		objGrid.sheetName = "업로드데이터";
		
	var objGrid2 = {};
		objGrid2.grid = this.grd_excelCode;
		objGrid2.title = "사유구분코드";
		objGrid2.sheetName = "참고코드";
		
		arrObj.push(objGrid);
		arrObj.push(objGrid2);
	
	// Grid Export
	this.gfn_gridExcelExport(arrObj, "BSDC반품 업로드양식", "active");
} 


/*========= 재고조사 상태 체크 ==============================*/
this.fn_chkInv = function( strOrgCd)
{
	this.ds_cond.setColumn(0,"ORG_CD", strOrgCd);
	
	var tx = new NXTransaction(this);
		
	tx.addInDataset	("ds_cond", "ds_cond:A");
	tx.addOutDataset("ds_InvChk", "ds_InvChk");
	tx.setCallback	("fn_callback");
	tx.setService	("ns/sm/si010/selectInvChk.do");  
	tx.setOption    ( {'async':false} );
	tx.execute		("selectInvChk");
	
	var invChk = 0;
	if(this.ds_InvChk. getRowCount() > 0)
	{
		invChk = this.ds_InvChk.getColumn(0,"INVCHK");
	}
	
	if(invChk != "0")
	{
		NXCore.alert("Inf.I115"); //Inf.I115=현재 재고조사중이므로 처리가 불가능합니다.
		return true;
	}
	else 
	{
		return false;
	}
}
]]></Script>
  </Form>
</FDL>
